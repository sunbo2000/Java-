# 1. 数据链路层概述

![image-20220711141907544](D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\image-20220711141907544.png)

## 1. 概念解释

- 链路(Link): 就是从一个结点到相邻结点的一段物理线路,而中间没有任何其他的交换结点
- 数据链路(Data Link): 是指把实现通信协议的硬件和软件加到链路上,就构成了数据链路
- 数据链路层以**帧**为单位处理数据 

## 2. 使用点对点信道的数据链路层

### 2.1 封装成帧

1.  <img src="D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\image-20220711142516508.png" alt="image-20220711142516508" style="zoom: 80%;" />
2.  <img src="D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\image-20220711142536083.png" alt="image-20220711142536083" style="zoom:80%;" />
3.  <img src="D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\image-20220711142558979.png" alt="image-20220711142558979" style="zoom:80%;" />
4.  <img src="D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\image-20220711142712563.png" alt="image-20220711142712563" style="zoom:80%;" />
5. ​     帧格式![image-20220711142756249](D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\image-20220711142756249.png)

### 2.2 差错检测

- 在帧尾添加检错码,接收方主机收到帧后通过检错码和检错算法检测帧是否有误码![image-20220711143010187](D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\image-20220711143010187.png)

### 2.3 可靠传输

尽管误码是不能完全避免的，但若能实现发送方发送什么, 接收方就能收到什么，就称为可靠传输。

## 3. 使用广播信道的数据链路层

### 3.1 共享式以太网的媒体接入控制协议CSMA/CD

![image-20220711150753360](D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\image-20220711150753360.png)

### 3.2 802.11局域网的媒体接入控制协议CSMA/CA![image-20220711150704728](D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\image-20220711150704728.png)

## 4. 数据链路层的互连设备

### 4.1 网桥和交换机的工作原理

### 4.2 集线器（物理层互连设备）与交换机的区别

![image-20220711151133751](D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\image-20220711151133751.png)

# 2. 封装成帧

## 1. 介绍

- **封装成帧** (framing) 就是在一段数据的前后分别添加首部和尾部，然后就构成了一个帧。
- 首部和尾部的一个重要作用就是进行**帧定界**。
- **帧头和帧尾中包含有重要的控制信息**

![img](D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\webp.webp)

问题: 发送方的数据链路层将上层交付下来的协议数据单元封装成帧后，还要通过物理层，将构成帧的各比特，转换成电信号交给传输媒体，那么接收方的数据链路层如何从物理层交付的比特流中提取出一个个的帧？

答：需要帧头和帧尾来做**帧定界**

![img](D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\webp-16575245274659.webp)

但比不是每一种数据链路层协议的帧都包含有帧定界标志，例如下面例子

![img](D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\webp-165752454636811.webp)

- ```
  前导码
  
  - 前同步码：作用是使接收方的时钟同步
  
  - 帧开始定界符：表明其后面紧跟着的就是MAC帧
  ```

  

另外以太网还规定了帧间间隔为96比特时间，因此，MAC帧不需要帧结束定界符

## 2. 透明传输

透明传输是指**数据链路层对上层交付的传输数据没有任何限制**，好像数据链路层不存在一样

解决帧界定标志在上层协议数据单元中出现的问题: 帧界定标志也就是个特定数据值，如果在上层交付的协议数据单元中， 恰好也包含这个特定数值，接收方就不能正确接收,所以数据链路层应该对上层交付的数据有限制，其内容不能包含帧定界符的值

**解决方法**：面向字节的物理链路使用**字节填充** (byte stuffing) 或**字符填充** (character stuffing)，面向比特的物理链路使用比特填充的方法实现透明传输

![img](D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\webp-165752900306213.webp)

发送端的数据链路层在数据中出现控制字符“SOH”或“EOT”的前面**插入一个转义字符“ESC”**(其十六进制编码是1B)。

接收端的数据链路层在将数据送往网络层之前删除插入的转义字符。

如果转义字符也出现在数据当中，那么应在转义字符前面插入一个转义字符 ESC。当接收端收到连续的两个转义字符时，就删除其中前面的一个。

# 3.差错检测

## 1.介绍

- 实际的通信链路都不是理想的，比特在传输过程中可能会产生差错: 1可能会变成0,而0也可能变成1。这称为**比特差错**。
- 在一段时间内，传输错误的比特占所传输比特总数的比率称为**误码率**BER(Bit Error Rate)。
- 使用**差错检测码**来检测数据在传输过程中是否产生了比特差错，是数据链路层所要解决的
  重要问题之一。

![image-20220711193041943](D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\image-20220711193041943.png)

## 2. 校验方法

1. 奇偶校验

2. 循环冗余校验

   - 收发双方约定好一一个生成多项式G(x);
   - 发送方基于待发送的数据和生成多项式计算出**差错检测码(冗余码)**，将其添加到待传输数据的后面一起传输; 
   - 接收方通过生成多项式来计算收到的数据是否产生了误码; 

   <img src="D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\image-20220711194505118.png" alt="image-20220711194505118"  />

   ![image-20220711194720699](D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\image-20220711194720699.png)

- 举例

  ![image-20220711200157732](D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\image-20220711200157732.png)

## 3. 总结

- 检错码只能检测出帧在传输过程中出现了差错,但并不能定位错误，因此无法纠正错误。
- 要想纠正传输中的差错，可以使用冗余信息更多的纠错码进行前向纠错。但纠错码的开销比较大，在计算机网络中较少使用。
- 循环冗余校验CRC有很好的检错能力(漏检率非常低)，虽然计算比较复杂，但非常易于用硬件实现，因此被广泛应用于数据链路层。
- 在计算机网络中通常采用我们后续课程中将要讨论的检错重传方式来纠正传输中的差错，或者仅仅是丢弃检测到差错的帧，这取决于数据链路层向其上层提供的是可靠传输服务还是不可靠传输服务。

# 4. 可靠传输(不局限于数据链路层)

## 1. 基本概念

![image-20220711202334743](D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\image-20220711202334743.png)

## 2. 可靠传输的实现机制(不局限于数据链路层)

- 停止 - 等待协议SW
- 回退 N 帧协议GBN
- 选择重传协议 SR

## 一. 停止-等待协议SW(Stop Wait)

![image-20220711204059317](D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\image-20220711204059317.png)

注: 

- 接收端检测到数据分组有误码时，将其丢弃并等待发送方的超时重传。但对于误码率较高的点对点链路，为使发送方**尽早重传**，也可**给发送方发送NAK分组**。
- 为了让接收方能够判断所收到的数据分组是否是重复的，需要给**数据分组编号**。由于停止等待协议的停等特性，**只需1个比特编号**就够了，即编号0和1。
- 为了让发送方能够判断所收到的ACK分组是否是重复的，需要给**ACK分组编号**，所用比特数量**与数据分组编号所用比特数量一样**。数据链路层一般不会出现ACK分组迟到的情况，因此**在数据链路层实现停止等待协议可以不用给ACK分组编号**。
- 超时计时器设置的**重传时间**应仔细选择。一般可将重传时间选为略大于”**从发送方到接收方的平均往返时间**”
  - 在数据链路层点对点的往返时间比较确定,重传时间比较好设定。
  - 然而在运输层，由于端到端往返时间非常不确定，设置合适的重传时间有时并不容易。

利用率停止等待协议信道利用率

![image-20220711210230334](D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\image-20220711210230334.png)

## 二. 回退N帧协议GBN(Go Back N)

![image-20220711213953436](D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\image-20220711213953436.png)

- 回退N帧协议在**流水线传输**的基础，上利用**发送窗口**来限制发送方连续发送数据分组的数量，是一种连续ARQ协议。
- 在协议的工作过程中**发送窗口和接收窗口不断向前滑动，因此这类协议又称为滑动窗回协议**。
- 由于回退N帧协议的特性，**当通信线路质量不好时，其信道利用率并不比停止 - 等待协议高**。

## 三. 选择重传协议SR

- **回退N帧协议**的接收窗口尺寸**WR只能等于1,**因此**接收方只能按序接收正确到达的数据分组**。
- 一个数据分组的误码就会导致其后续多个数据分组不能被接收方按序接收而丢弃(尽管它们无乱序和误码)。这必然会造成发送方对这些数据分组的超时重传，显然这是对通信资源的极大浪费。
- 为了进一步提高性能，可设法只重传出现误码的数据分组。因此，接收窗口的尺寸**WR不应再等于1 (而应大于1)** ,以便**接收方先收下失序到达但无误码并且序号落在接收窗口内的那些数据分组**，等到所缺分组收齐后再一并送交上层。这就是**选择重传协议**。

![image-20220711222754295](D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\image-20220711222754295.png)

# 5. 点对点PPP协议(point to point protocol)

- 点对点协议 PPP(Point-to-Point Protocol)是目前使用最广泛的点对点数据链路层协议。

## 1. 帧格式

![image-20220712111026929](D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\image-20220712111026929.png)

## 2. 封装成帧 - 透明传输

![image-20220712111143314](D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\image-20220712111143314.png)

## 2. 差错检验

- CRC检验(循环冗余校验码)
- PPP 数据链路层向上不提供可靠传输服务,正确保留,错误丢弃

# 6. 使用广播信道的数据链路 

## 1. 媒体接入控制

### 1. 概念

- 共享信道要着重考虑的一一个问题就是如何协调多个发送和接收站点对一个共享传输媒体的占用，即**媒体接入控制MAC**(Medium Access Control)。
- ![image-20220712113042712](D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\image-20220712113042712.png)

### 2. 静态划分信道

#### 2.1 信道复用

- 复用: 通过一条物理线路同时传输多路用户的信号
- 当网络中传输媒体的传输容量大于多条单一信道传输的总通信量时， 可利用复用技术在一条
  物理线路.上建立多条通信信道来充分利用传输媒体的带宽。

- 频分：一条路同一时间走两种车；
- 时分：一条路一种车只能在属于他的时间经过；
- 码分：给两种车分别编号（编码），到了终点再根据编号区分；

### 3. 随机接入

![image-20220712122448577](D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\image-20220712122448577.png)

#### 3.1 多址接入

![image-20220712122624369](D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\image-20220712122624369.png)

#### 3.2 载波监听

#### 3.3 碰撞检测

![image-20220712122840130](D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\image-20220712122840130.png)

# 7. MAC 地址,IP地址,ARP协议

- MAC 地址:是以太网的MAC子层所使用的地址 **属于数据链路层**

  

- IP 地址是 TCP/IP 体系结构**网际层**所使用的地址

- ARP 协议属于TCP/IP 体系结构的**网际层**,其作用是已知设备所分配到的 IP 地址,使用 ARP 协议可以通过该 IP 地址获取到设备的 MAC 地址

  尽管 IP 地址和 ARP 协议属于 TCP/IP 体系结构的网际层(而不属于数据链路层)，但是它们与 MAC 地址存在一定的关系，并且我们日常的网络应用都离不开 MAC 地址、IP 地址以及 ARP 协议。因此，我们将这三者放在一起讨论。

## 7.1 MAC 地址

- 使用点对点信道的数据链路层不需要使用地址

- 使用广播信道的数据链路层必须使用地址来区分各主机

![img](D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\webp-165761173019315.webp)

### 1). 广播信道的数据链路层必须使用地址（MAC）

![img](D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\webp-165761176933317.webp)

## 7.2 IP 地址

- IP地址属于网络层的范畴，不属于数据链路层的范畴
- 下面内容讲的是IP地址的使用，详细的IP地址内容在网络层中介绍

![img](D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\webp-165761198143619.webp)

### 1) 从网络体系结构看IP地址与MAC地址

![img](D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\webp-165761200090121.webp)

### 2) 数据包转发过程中IP地址与MAC地址的变化情况

![img](D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\webp-165761204932523.webp)

![img](D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\webp-165761206488225.webp)

## 7.3 ARP协议(网络层)

![img](D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\webp-165761208762027.webp)

ARP高速缓存表

![img](D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\webp-165761209980229.webp)

当主机B要给主机C发送数据包时，会首先在自己的ARP高速缓存表中查找主机C的IP地址所对应的MAC地址，但未找到，因此，主机B需要发送ARP请求报文，来获取主机C的MAC地址	

![img](D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\webp-165761211639231.webp)

ARP请求报文有具体的格式，上图的只是简单描述

ARP请求报文被封装在MAC帧中发送，目的地址为广播地址

主机B发送封装有ARP请求报文的广播帧，总线上的其他主机都能收到该广播帧

![img](D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\webp-165761220025633.webp)

![img](D:\A.学习资料\A.笔记\19.计算机网络\数据链路层.assets\webp-165761221216435.webp)

## 7.4 IP 地址和 MAC 地址

### IP 地址 

每一台计算机使用的 IP 地址，是由 (ISPInternet Service Provider)（指提供 Internet 服务的公司，比如电信、网通、移动等）负责分配的。通常情况下，计算机每次连接网络使用的 IP 地址都是不固定的，换句话说，**ISP 会动态分配一个 IP 地址给它**。

**一台计算机可以拥有一个独立的 IP 地址，一个局域网也可以拥有一个独立的 IP 地址**（对外就好像只有一台计算机）。**对于目前广泛使用 IPv4 地址，它的资源是非常有限的，一台计算机一个 IP 地址是不现实的，往往一个局域网才拥有一个 IP 地址。**

计算机之间进行通信，必须要知道对方的 IP 地址。实际上，计算机发出的数据包中已经附带了 IP 地址，把数据包发送给路由器以后，路由器会根据 IP 地址找到对方的地理位置，完成一次数据的传递。路由器有非常高效和智能的算法，很快就会找到目标计算机。

### MAC 地址

通常情况下，一个局域网才能拥有一个独立的 IP，换句话说，IP 地址只能定位到一个局域网，无法定位到具体的某个设备。这可怎么办呀？这样也没法通信啊。

其实，真正能唯一标识设备(**网络适配器(网络接口)地址**)的是 MAC 地址。MAC 地址是 Media Access Control Address 的缩写，直译为“**媒体访问控制地址**”，也称为**局域网地址**（LAN Address），**以太网地址**（Ethernet Address）或**物理地址**（Physical Address）。

- mac 地址无法表示网络, mac 是局域网地址
- 假设只拥有MAC地址的话，只有在同一网络区域内，才能进行数据传输，不能跨网络区域。
- 如果想跨网络区域进行数据传递，最现实的方法就是借助 ISP 提供的网络区域。
- ISP 能提供全球互联的网络——因特网，借助因特网可以传输数据给连接因特网上的机器。