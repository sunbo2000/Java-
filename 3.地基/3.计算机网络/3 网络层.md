# 1. 概述

## 1. 主要任务

实现网络互连,进而实现数据在网络间的传送

## 2. 核心功能

### 1. 转发

### 2. 路由选择

### 3. 可靠传输/不可靠传输

![image-20220714121319464](assets\image-20220714121319464.png)

# 2. 网络层提供的两种服务

## 1. 面向连接的虚电路服务

- **可靠通信由网络来保证**
- 必须建立网络层的连接一**虚电路VC**(Virtual Circuit)
- 通信双方沿着已建立的虚电路发送分组
- 虚电路是一条**逻辑连线**,分组都沿着逻辑连接按照存储转发方式传送

- **目的主机的地址仅在连接建立阶段使用**，之后每个分组的首部只需携带一条虚电路的编号(构成虚电路的每一-段链路都有一一个虚电路编号)。

- 这种通信方式如果再使用可靠传输的网络协议，就可使所发送的分组最终正确到达接收方(**无差错按序到达、不丢失、不重复**)

- 通信结束后释放虚电路

  ![image-20220714122857699](assets\image-20220714122857699.png)

## 2. 无连接的数据报服务

- **可靠通信应当由用户主机来保证**
- **不需要建立网络层连接**
- **每个分组可走不同的路径**
- 每个分组的**首部必须携带目的主机的完整地址**
- 这种通信方式所传送的分组**可能误码、丢失、重复和失序。**
- 由于网络本身不提供端到端的可靠传输服务，这就使网络中的路由器可以做得比较简单，而且价格低廉(与电信网的交换机相比较)
- 因特网采用了这种设计思想，也就是将**复杂的网络处理功能置于因特网的边缘**(用户主机和其内部的运输层)，而将相对**简单的尽最大努力的分组交付功能置于因特网核心。**

## 3. 比较

![image-20220714123429092](assets\image-20220714123429092.png)

# 3. IPV4

## 1. 概述

- **IPv4 地址**就是给因特网(Internet)上的**每一 台主机(或路由器)的每一个接口**分配一个在全世界范围内是**唯一的32比特的标识符**。

![image-20220714123743917](assets\image-20220714123743917.png)

- 点分十进制表示方法

  ![image-20220714124000803](assets\image-20220714124000803.png)

## 2.分类

### 1. 分类编址

<img src="assets\image-20220714124842718.png" alt="image-20220714124842718" style="zoom: 67%;" />

<img src="assets\image-20220714124942541.png" alt="image-20220714124942541" style="zoom:50%;" />

#### 1. A 类

![image-20220714125352468](assets\image-20220714125352468.png)

- A 类,**最小网络号保留不指派**,**最大网络号作为本地环回测试地址不指派**

#### 2. B类

![image-20220714125725017](assets\image-20220714125725017.png)

#### 3. C 类

![image-20220714130302879](assets\image-20220714130302879.png)

#### 4. 常见特殊地址

![image-20220714131038857](assets\image-20220714131038857.png)

#### 5. 编址实例

![image-20220714131449699](assets\image-20220714131449699.png)

### 2. 划分子网

![image-20220714135349327](assets\image-20220714135349327.png)

![image-20220714135236681](assets\image-20220714135236681.png)

![image-20220714135632104](assets\image-20220714135632104.png)

####  	默认子网掩码

![image-20220714140049255](assets\image-20220714140049255.png)

#### 总结

![image-20220714140112111](assets\image-20220714140112111.png)

### 3. 无分类编址

- 划分子网在一定程度.上缓解了因特网在发展中遇到的困难，但是**数量巨大的C类网因为其地址空间太小并没有得到充分使用**，而因特网的IP地址仍在加速消耗，整个IPv4地址空间面临全部耗尽的威胁。

#### CIDR使用**斜线记法**

![image-20220714142004626](assets\image-20220714142004626.png)

#### 路由聚合(构造超网)

![image-20220714142535970](assets\image-20220714142535970.png)

- **网络前缀越长,地址块越小,路由越具体**
- 若路由器查表转发分组时发现有多条路由可选，则选择网络前缀最长的那条，这称为最长前缀匹配，
  因为这样的路由更具体。

#### 总结

![image-20220714143057695](assets\image-20220714143057695.png)

## 3. IPV4 地址的应用规划

### 1. 定长子网掩码 FLSM

- 使用同一个子网掩码划分子网
- 每个子网划分的 IP 数量相同,造成 IP 地址的浪费

![image-20220714145037942](assets\image-20220714145037942.png)

![image-20220714145134319](assets\image-20220714145134319.png)

### 2. 变长子网掩码 VLSM

![image-20220714145608503](assets\image-20220714145608503.png)

# 4. IP 数据报的发送和转发过程

![image-20220714153435102](assets\image-20220714153435102.png)

# 5. 静态路由配置

- 静态路由配置是指**用户或网络管理员使用路由器的相关命令给路由器人工配置路由表**。
  - 这种人工配置方式简单、开销小。但**不能及时适应网络状态(流量、拓扑等)的变化。**
  - 一般只在小规模网络中采用。
- 使用静态路由配置可能出现以下导致产生路由环路的错误
  - 配置错误
  - 聚合了不存在的网络
  - 网络故障

**路由表可以通过网络管理员静态配置,该方案只适用于小规模网络。改方案不能快速的响应新的网络结构以及关系**
**的变化，并诅配置错误还有可能导致环路的问题。**

# 6. 动态路由配置

- 路由器通过路由选择协议**自动获取路由信息**

- 比价复杂,开销大**,能较好的适应网络状态的变化**

- **适用于大规模网络**

   ![image-20220714162132391](assets\image-20220714162132391.png)

![image-20220714162237323](assets\image-20220714162237323.png)

## 1. 路由选择协议

### - 路由器的基本结构

![image-20220714162804315](assets\image-20220714162804315.png)

- 路由表- -般仅包含从目的网络到下一跳的映射
- 路由表需要对网络拓扑变化的计算最优化
- 转发表是从路由表得出的
- 转发表的结构应当使查找过程最优化

### 1. RIP 协议

- **路由信息协议RIP(Routing Information Protocol)**是内部网关协议IGP中最先得到广泛使用的协议
- 之一，其相关标准文档为RFC 1058。
- RIP要求自治系统AS内的每一-个路由器都要维护从它自己到AS内其他每-一个网络的距离记录。这是一组距离，称为“ **距离向量D-V(Distance-Vector)**”
- RIP使用**跳数(Hop Count)**作为度量(Metric)来衡量到达目的**网络的距离**。
  - 路由器到直连网络的距离定义为1。
  - 路由器到非直连网络的距离定义为所经过的路由器数加1。
  - 允许一条路径最多只能包含15个路由器。 **“距离”等于16时相当于不可达**。
- 因此，RIP只**适用于小型互联网**。

![image-20220714163620448](assets\image-20220714163620448.png)

- RIP认为**好的路由**就是“距离短”的路由，也就是**所通过路由器数量最少的路由**。
- 当到达同一目的网络有多条“距离相等"的路由时，可以进行**等价负载均衡**。
- RIP包含以下三个要点:
  - **和谁交换信息** 仅和相邻路由器交换信息
  - **交换什么信息** 自己的路由表
  - **何时交换信息** 周期性交换(例如每30秒)

![image-20220714164656506](assets\image-20220714164656506.png)

### 2. 开放最短路径优先 OSPF 协议

#### 1. 概述

- 开放最短路径优先 OSPF(Open Shortest Path First) ,是为克服RIP的缺点在1989年开发出来的。

  - “开放”表明 OSPF 协议不是受某一家厂商控制，而是**公开发表**的。

  - '最短路径优先”是因为使用了 **Dijkstra** 提出的**最短路径算法 SPF**。

- OSPF 是**基于链路状态**的，而不像RIP那样是基于距离向量的。
  - OSPF 采用 SPF 算法计算路由，从算法上保证了**不会产生路由环路**。

- 链路状态是指本路由器都和哪些路由器**相邻**，以及相应链路的"代价”(cost), **“代价”**用来表示费用、距离、时延、带宽，等等。这些都由**网络管理人员来决定**。

- OSPF **不限制网络规模**，更新效率高，收敛速度快。

#### 2. 基本工作原理

1. 使用OSPF的每个路由器都会产生**链路状态通告LSA**(Link State Advertisement)。LSA中包含以下内容:

   - 直连网络的链路状态信息

   - 邻居路由器的链路状态信息

2. LSA 被封装在**链路状态更新分组**LSU中，采用**洪泛法发送**。

<img src="assets\1654532138071-1aa05173-3ea3-49dd-8787-3c891103f386.png" alt="image.png" style="zoom:80%;" />

使用 OSPF 的**每个路由器都有一个链路状态数据库LSDB**, 用于存储LSA，**形成带权有向图**，采用**基于 Dijkstra 的 SPF 算法算出最短路径。**

![image.png](assets\1654532205470-aad8b7bf-6ebd-4f16-a035-f3c7f0bbd49b.png)

![image-20220714172225876](assets\image-20220714172225876.png)

# 7. IP 数据报

##  1. 首部格式

![image.png](assets\1654532833798-58d9dd91-7a5b-41d7-8da5-de9588417e9b.png)

其中黄色部分用于分片，为什么要分片？由于链路层以太网规定了最大的传输单元MTU1500字节，ip数据超出的部分需要进行分片。
**生存时间**：防止数据报在网络中迷路，或者形成环路。每经过一跳路由器TTL减一，为0就丢弃该数据报。
**校验和**：网络层 ip 协议**不提供可靠传输**，校验和只是用于**首部数据的校验**，防止首部传输出错的情况下。由于首部生存时间会一直变，每个路由器都得重新生成新的校验和，很耗时。IPV6中不再计算首部校验和。

## 2. 网际控制报文协议 ICMP

为了更有效地转发IP数据报和提高交付成功的机会,在网际层使用了网际控制报文协议 **ICMP(Internet Control Message Protocol)**。主机或路由器使用ICMP来发送差错报告报文和询问报文。ICMP报文被封装在IP数据报中发送。
